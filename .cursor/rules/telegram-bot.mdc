---
description: –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è Telegram –±–æ—Ç–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
globs: ["src/bot/**/*.py", "src/core/markdown_service.py"]
---

# –ü—Ä–∞–≤–∏–ª–∞ Telegram –±–æ—Ç–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
```python
# handlers/mexc.py
async def handle_mexc_command(message: Message, service: MexcInfoService) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /mexc."""
    try:
        symbol = extract_symbol_from_command(message.text, "mexc")
        if not symbol:
            await message.reply("‚ùå –£–∫–∞–∂–∏—Ç–µ —Å–∏–º–≤–æ–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä: `/mexc BTC_USDT`", parse_mode=ParseMode.MARKDOWN_V2)
            return

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        response_text, errors = await service.get_info(symbol)

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
        await message.reply(response_text, parse_mode=ParseMode.MARKDOWN_V2, disable_web_page_preview=True)

        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        if errors:
            logger.warning(f"MEXC command errors for {symbol}: {errors}")

    except Exception as e:
        logger.error(f"Error handling mexc command: {e}")
        await message.reply("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã")

# handlers/gate.py
async def handle_gate_command(message: Message, service: GateInfoService) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /gate."""
    # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è Gate.io
    pass

# handlers/cex.py
async def handle_cex_command(message: Message, service: CexAggregatorService) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /cex."""
    # –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    pass
```

### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –∏–∑ –∫–æ–º–∞–Ω–¥—ã
```python
def extract_symbol_from_command(text: str, command: str) -> Optional[str]:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –∏–∑ –∫–æ–º–∞–Ω–¥—ã."""
    # –£–¥–∞–ª—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–æ—Ç–∞ @username
    text = re.sub(r'@[\w]+', '', text).strip()

    # –ü–∞—Ç—Ç–µ—Ä–Ω: /command SYMBOL
    pattern = rf'^/{command}\s+(.+)$'
    match = re.match(pattern, text, re.IGNORECASE)

    if match:
        symbol = match.group(1).strip()
        return symbol.upper()

    return None
```

## –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –≤ Dispatcher

### –û—Å–Ω–æ–≤–Ω–æ–π dispatcher
```python
async def create_dispatcher(container: DependencyContainer) -> Dispatcher:
    """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram dispatcher."""
    dp = Dispatcher()

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
    @dp.message(Command("start"))
    async def start_handler(message):
        start_text = container.markdown_service.convert_to_markdown_v2(
            "–ö–æ–º–∞–Ω–¥—ã:\n‚Ä¢ `/cex BTC` (–≤—Å–µ –±–∏—Ä–∂–∏)\n‚Ä¢ `/mexc 1_USDT` (MEXC)\n‚Ä¢ `/gate BTC_USDT` (Gate.io)"
        )
        await message.reply(start_text, parse_mode=ParseMode.MARKDOWN_V2, disable_web_page_preview=True)

    # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    @dp.message(Command("mexc", ignore_case=True))
    async def mexc_handler(message):
        await handle_mexc_command(message, container.cex_service)

    @dp.message(Command("gate", ignore_case=True))
    async def gate_handler(message):
        await handle_gate_command(message, container.gate_service)

    @dp.message(Command("cex", ignore_case=True))
    async def cex_handler(message):
        await handle_cex_command(message, container.cex_aggregator_service)

    return dp
```

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥—Ä—É–ø–ø
```python
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤
@dp.message(lambda message: message.text and message.text.lower().startswith('/mexc') and
           message.chat.type in [ChatType.GROUP, ChatType.SUPERGROUP])
async def mexc_group_handler(message):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ /mexc –∫–æ–º–∞–Ω–¥ –≤ –≥—Ä—É–ø–ø–∞—Ö
    text_lower = message.text.lower()
    # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ /mexc –∫–æ–º–∞–Ω–¥—ã –≤ –≥—Ä—É–ø–ø–∞—Ö
    if '@' not in text_lower or '@' in text_lower:
        await handle_mexc_command(message, container.cex_service)
```

## MarkdownV2 —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### MarkdownService
```python
class MarkdownService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ MarkdownV2."""

    # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, —Ç—Ä–µ–±—É—é—â–∏–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    SPECIAL_CHARS = r'_*[]()~`>#+-=|{}.!'

    @staticmethod
    def escape_markdown(text: str) -> str:
        """–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è MarkdownV2."""
        if not text:
            return text

        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        escaped = re.sub(r'([' + re.escape(MarkdownService.SPECIAL_CHARS) + r'])', r'\\\1', text)

        # –ò—Å–∫–ª—é—á–µ–Ω–∏—è: –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞

        return escaped

    def convert_to_markdown_v2(self, text: str) -> str:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ MarkdownV2."""
        if not text:
            return text

        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        return self.escape_markdown(text)
```

### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω –∏ –¥–∞–Ω–Ω—ã—Ö
```python
def format_price_info(self, symbol: str, data: FuturesTickerData) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ü–µ–Ω–µ."""
    lines = []

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    lines.append(f"üîî *{self.escape_markdown(symbol)}* | Status üü¢")
    lines.append("")

    # –°–ø—Ä–µ–¥
    spread_str, color = calculate_spread(data.lastPrice, data.fairPrice)
    lines.append(f"üìà *Spread:* {spread_str} {color} SHORT")
    lines.append("üí∞ *Last:* $43,250.50 | *Fair:* $42,200.30 | *Index:* $42,180.75")
    lines.append(f"üìä *Volume 24h:* 1,500,000 BTC | 65,000,000,000 USDT")
    lines.append("")

    # Buy Limit
    lines.append("*Buy Limit:* $25,000")
    lines.append("")

    # Index
    lines.append("*Index:* Binance 40.0% ‚Ä¢ OKX 30.0% ‚Ä¢ Huobi 20.0% ‚Ä¢ Other 10.0%")
    lines.append("")

    # Networks
    lines.append("*ETHEREUM:* D: ‚úÖ | W: ‚úÖ")
    lines.append(f"`{self.escape_markdown(data.contract_address)}`")

    # Links
    lines.append(f"[DexScreener](https://dexscreener.com/ethereum/{data.contract_address}) | [GMGN](https://gmgn.ai/eth/token/{data.contract_address})")
    lines.append("")
    lines.append(f"üîó [Trade](https://futures.mexc.com/exchange/{symbol})")

    return self.convert_to_markdown_v2("\n".join(lines))
```

## Fair Price Alert —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–æ—Ä–º–∞—Ç –∞–ª–µ—Ä—Ç–∞
```python
def format_fair_price_alert(self, symbol: str, data: AlertData) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞ –æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Ü–µ–Ω–µ."""
    lines = []

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    lines.append(f"‚ö†Ô∏è *Fair Price Alert* | {data.color} SHORT")
    lines.append("")

    # –ë–∏—Ä–∂–∞
    lines.append(f"üè¶ *{data.exchange}*")
    lines.append("")

    # –¢–∏–∫–µ—Ä –∏ —Å—Å—ã–ª–∫–∞
    lines.append(f"üìä *Ticker:* [{data.symbol}]({data.trade_url})")
    lines.append(f"üìã *Copy:* `{data.symbol}`")
    lines.append(f"üí∞ *Last Price:* `{data.last_price}`")
    lines.append(f"üéØ *Fair Price:* `{data.fair_price}`")
    lines.append(f"üìà *Spread:* `{data.spread}`")
    lines.append(f"üìä *Volume 24h:* `{data.volume}`")
    lines.append(f"üèõÔ∏è *Index Pool:* {data.index_info}")
    lines.append(f"üåê *DEX Networks:* {data.dex_links}")
    lines.append(f"üí∞ *Buy Limit:* `{data.buy_limit}`")
    lines.append("")

    # –í—Ä–µ–º—è –∏ TTL
    lines.append(f"üïê `{data.timestamp}` | TTL: 1h")

    return self.convert_to_markdown_v2("\n".join(lines))
```

## –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

### Telegram alert service
```python
class TelegramAlertService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ –≤ Telegram."""

    def __init__(self, bot_token: str, chat_id: str):
        self.bot_token = bot_token
        self.chat_id = chat_id
        self.bot = Bot(token=bot_token)

    async def send_alert(self, message: str) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞."""
        try:
            await self.bot.send_message(
                chat_id=self.chat_id,
                text=message,
                parse_mode=ParseMode.MARKDOWN_V2,
                disable_web_page_preview=True
            )
            return True
        except Exception as e:
            logger.error(f"Failed to send alert: {e}")
            return False

    async def close(self) -> None:
        """–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è."""
        await self.bot.session.close()
```

## TTL —Å–∏—Å—Ç–µ–º–∞ (Time To Live)

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–æ–º –∞–ª–µ—Ä—Ç–æ–≤
```python
class AlertCooldownManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—É–ª–¥–∞—É–Ω–∞ –∞–ª–µ—Ä—Ç–æ–≤."""

    def __init__(self, ttl_hours: int = 1):
        self.ttl_seconds = ttl_hours * 3600
        self.last_alerts: Dict[str, float] = {}  # symbol -> timestamp

    def can_send_alert(self, symbol: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–∞."""
        last_time = self.last_alerts.get(symbol, 0)
        current_time = time.time()

        if current_time - last_time >= self.ttl_seconds:
            self.last_alerts[symbol] = current_time
            return True

        return False

    def cleanup_old_alerts(self) -> None:
        """–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π."""
        current_time = time.time()
        expired_symbols = [
            symbol for symbol, timestamp in self.last_alerts.items()
            if current_time - timestamp > self.ttl_seconds * 2  # –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 2 TTL
        ]

        for symbol in expired_symbols:
            del self.last_alerts[symbol]
```